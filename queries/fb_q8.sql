WITH filtered_rankings AS( SELECT * FROM rankings WHERE pagerank between 2000 and 3000 ) SELECT allowed_records.pageurl, COUNT(*) OVER () as total_rankings_count FROM filtered_rankings JOIN ( SELECT pageurl FROM filtered_rankings ORDER BY avgduration DESC LIMIT 100 ) AS allowed_records ON allowed_records.pageurl = filtered_rankings.pageurl ORDER BY pagerank desc LIMIT 20 OFFSET 0 ;